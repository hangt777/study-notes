# 四个常见通信协议

## 1、UASRT（串口通信）

### 概述

串口通信是一种通过发送和接收位序列来实现数据传输的协议。它使用通信线路上的信号进行信息交换。通常涉及两个主要引脚：发送（TX）和接收（RX）。

### USART

USART（Universal Synchronous/Asynchronous Receiver/Transmitter）是一种通用的串行通信接口。它支持同步和异步通信，允许数据同步传输或通过启用时钟信号进行异步传输。

### 通信协议

**异步通信**：逐位传输，每个字符之间使用起始位和停止位分隔。

**同步通信**：使用外部时钟进行同步。通常使用时钟引脚（CLK）来确保数据传输的同步性。

### 常见配置和设置

**波特率**：决定数据传输速率。

 ${T}_{X}$/  ${R}_{X}$波特率 ＝ ${f}_{CK}$/(16*USARTDIV)

这里的fCK是给外设的时钟(PCLK1用于USART2、 3、 4、 5， PCLK2用于USART1)
USARTDIV是一个无符号的定点数。这12位的值设置在USART_BRR寄存器。

**注： 在写入USART_BRR之后，波特率计数器会被波特率寄存器的新值替换。因此，不要在通信进行中改变波特率寄存器的数值**

**数据位数**：指示每个字符的位数，通常为8位。

![数据位数示意图][shujuwei]

[shujuwei]: https://th.bing.com/th/id/OIP.YfvpufPUohTsq2CVznXRRwHaEP?rs=1&pid=ImgDetMain

**停止位**：确定字符结束的位数。

**奇偶校验**：用于检测传输错误和数据完整性。

**以上参数的配置主要见对应STM32芯片的参考手册**

**起始位侦测**：![起始位侦测示意图][qishiwei]

[qishiwei]:https://th.bing.com/th/id/OIP.YfvpufPUohTsq2CVznXRRwHaEP?rs=1&pid=ImgDetMain

### 使用注意事项

确定双方通信设置相匹配。
注意电平转换和适配器使用。

## 2、I2C协议

### 概念

I2C（Inter-Integrated Circuit）协议是一种广泛使用的串行通信协议，可实现集成电路、传感器和其他电子设备之间的通信。它是一种多主机、多从机协议，意味着可以将多个设备连接到同一总线，并彼此进行通信。

**主机和从机设备**：在I2C系统中，通常有一个主机设备发起通信，并且一个或多个从机设备响应主机的请求。

### 通信过程

1、主机发送起始信号启用总线

2、主机发送一个字节数据指明从机地址和后续字节的传送方向

3、被寻址的从机发送应答信号回应主机

4、发送器发送一个字节数据

5、接收器发送应答信号回应发送器

6、........ （循环步骤4、5）

7、通信完成后主机发送停止信号释放总线

第4步和第5步用的是发送器和接收器，不是主机和从机，这是由第一个字节的最后一位决定主给从发，还是从给主发。

也就是说，第一个字节和最后的停止信号一定是主机发给从机，但中间就不一定了。

**发送数据过程中不允许改变发送方向**

### 寻址

I2C总线上传送的数据是广义的，既包括地址，又包括真正的数据。

主机在发送起始信号后必须先发送一个字节的数据，该数据的高7位为从机地址，最低位表示后续字节的传送方向，‘0’表示主机发送数据给从机，‘1’表示从机发送数据给主机。

总线上所有的从机接收到该字节数据后都将这7位地址与自己的地址进行比较，如果相同，则认为自己被主机寻址，然后再根据第8位将自己定为发送器或接收器。

### 4种信号

**I2C协议最基础的几种信号**：**起始**、**停止**、**应答**和**非应答**信号。

**起始信号**：I2C协议规定，SCL处于高电平时，SDA由高到低变化，这种信号是起始信号。

**停止信号**：I2C协议规定，SCL处于高电平，SDA由低到高变化，这种信号是停止信号。

起始信号和停止信号都是由主机发出，起始信号产生后总线处于占用状态，停止信号产生后总线被释放，处于空闲状态。

**数据有效性**：I2C协议对数据的采样发生在SCL高电平期间，除了起始和停止信号，在数据传输期间，SCL为高电平时，SDA必须保持稳定，不允许改变，在SCL低电平时才可以进行变化。

![数据有效性示意图][def]

[def]: https://pic2.zhimg.com/80/v2-10b284defbc0184f4f095c729800658d_1440w.webp

**应答信号**：应答信号出现在1个字节传输完成之后，即第9个SCL时钟周期内，此时主机需要释放SDA总线，把总线控制权交给从机，由于上拉电阻的作用，此时总线为高电平，如果从机正确的收到了主机发来的数据，会把SDA拉低，表示应答响应。

![应答信号示意图][yingda]

[yingda]: https://pic2.zhimg.com/80/v2-2c40fab6f6bdbf2fbc80b1f8ddf524b5_1440w.webp

**非应答信号**：当第9个SCL时钟周期时，SDA保持高电平，表示非应答信号。

![非应答信号示意图][feiyingda]

[feiyingda]: https://pic4.zhimg.com/v2-10ddbba1b3056607972fd2d369860073_r.jpg

### 时序

**1、主机向从机发送数据**

![1][1]

[1]:https://img-blog.csdnimg.cn/510df21606234955a16eaa4717fbc6fe.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAemhhbmdkdWFuZ19LSEtX,size_17,color_FFFFFF,t_70,g_se,x_16

**2、从机向主机发送数据**

![2][2]

[2]:https://img-blog.csdnimg.cn/58dabecb32ab49989418215ac4ac9cbf.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAemhhbmdkdWFuZ19LSEtX,size_17,color_FFFFFF,t_70,g_se,x_16

**3、主机先向从机发送数据，然后从机再向主机发送数据**

![3][3]

[3]:https://img-blog.csdnimg.cn/aca3b870034446ceaa4a31391cb5928c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAemhhbmdkdWFuZ19LSEtX,size_20,color_FFFFFF,t_70,g_se,x_16

**注：S：起始信号，A：应答信号，A非表示非应答，P：终止信号**

## 3、CAN协议

### 显形隐形电平

CAN-bus发布了ISO11898和ISO11519两个通信标准，此两个标准中差分电平的特性不相同。

![4][4]

[4]:https://th.bing.com/th/id/OIP.WmOWM467KE9ZDwLG-A0-bAHaET?rs=1&pid=ImgDetMain

**显性电平**：总线上只要有1个节点驱动为显性，则总线表现为显性位电平，逻辑解析为“0”。

**隐形电平**：只有总线上的各节点都不将总线驱动成显性电平，总线才表现为隐形位对应的电平，逻辑解析为“1”。

**位填充**：位填充是为防止突发错误而设定的功能。当同样的电平持续 5 位时，则添加一个位的反型数据。

### 数据帧

数据帧结构上由7个段组成，其中根据仲裁段ID码长度的不同，分为标准帧（CAN2.0A）和扩展帧（CAN2.0B）。

![5][5]

[5]:https://th.bing.com/th/id/R.c375adf24ef6542d828d4ca4ed7dac72?rik=h%2fHTqeUyKykndQ&riu=http%3a%2f%2fxilinx.eetrend.com%2ffiles%2f2021-09%2f%E5%8D%9A%E5%AE%A2%2f100553964-221602-tu_2-2shu_ju_zheng_zheng_jie_gou_.png&ehk=jj1eDlhc8p68vQbmvsfuSYpJNYSUMF13Sr%2b1Ei5zdgg%3d&risl=&pid=ImgRaw&r=0

**数据帧机构**：**帧起始**、**帧结束**、**仲裁段**、**控制段**、**数据段**、**CRC段**、**ACK段**。

**CAN协议相关内容**及**CAN Cubemx配置**详见：https://blog.csdn.net/XiaoXiaoPengBo/article/details/116206252

## 4、SPI协议

### 概念

SPI（Serial Peripheral Interface）是一种**全双工、同步**的串行通信协议，常用于连接微控制器（MCU）与外部设备。它包括一个主设备和一个或多个从设备。主设备通过四根线（时钟、数据输入、数据输出、片选）与从设备通信。SPI协议具备高速传输、简单实现等特点。

### SPI特性

SPI总线包括4条逻辑线，定义如下：

MISO：Master input slave output 主机输入，从机输出（数据来自从机）

MOSI：Master output slave input 主机输出，从机输入（数据来自主机）

SCLK ：Serial Clock 串行时钟信号，由主机产生发送给从机

SS：Slave Select 片选信号，由主机发送，以控制与哪个从机通信，通常是低电平有效信号。

其他制造商可能会遵循其他命名规则，但是最终他们指的相同的含义。以下是一些常用术语：

MISO也可以是SIMO，DOUT，DO，SDO或SO（在主机端）

MOSI也可以是SOMI，DIN，DI，SDI或SI（在主机端）

NSS也可以是CE，CS或SSEL

SCLK也可以是SCK

### 时钟频率

SPI总线上的主机必须在通信开始时候配置并生成相应的时钟信号。在每个SPI时钟周期内，都会发生全双工数据传输。

主机在MOSI线上发送一位数据，从机读取它，而从机在MISO线上发送一位数据，主机读取它。

就算只进行单向的数据传输，也要保持这样的顺序。这就意味着无论接收任何数据，必须实际发送一些东西！在这种情况下，我们称其为虚拟数据

从理论上讲，只要实际可行，时钟速率就可以是您想要的任何速率，当然这个速率受限于每个系统能提供多大的系统时钟频率，以及最大的SPI传输速率。

### 时钟极性 CKP/Clock Polarity

除了配置串行时钟速率（频率）外，SPI主设备还需要配置时钟极性。

根据硬件制造商的命名规则不同，时钟极性通常写为CKP或CPOL。时钟极性和相位共同决定读取数据的方式，比如信号上升沿读取数据还是信号下降沿读取数据

CKP可以配置为1或0。这意味着我们可以根据需要将时钟的默认状态（IDLE）设置为高或低。极性反转可以通过简单的逻辑逆变器实现。**正确设置CKP和CKE需要参考设备的数据手册。**

CKP = 0：时钟空闲IDLE为低电平 0

CKP = 1：时钟空闲IDLE为高电平1

### 时钟相位 CKE /Clock Phase (Edge)

除配置串行时钟速率和极性外，SPI主设备还应配置时钟相位（或边沿）。根据硬件制造商的不同，时钟相位通常写为CKE或CPHA

顾名思义，时钟相位/边沿，也就是采集数据时是在时钟信号的具体相位或者边沿

CKE = 0：在时钟信号SCK的第一个跳变沿采样

CKE = 1：在时钟信号SCK的第二个跳变沿采样

### SPI通讯模式：

SPI通信有4种不同的模式，不同的从设备可能在出厂是就是配置为某种模式，这是不能改变的；但我们的通信双方必须是工作在同一模式下，所以我们可以对我们的主设备的SPI模式进行配置，通过CPOL（时钟极性）和CPHA（时钟相位）来控制我们主设备的通信模式

时钟极性CPOL是用来配置SCLK的电平出于哪种状态时是空闲态或者有效态，时钟相位CPHA是用来配置数据采样是在第几个边沿：

CPOL=0，表示当SCLK=0时处于空闲态，所以有效状态就是SCLK处于高电平时；

CPOL=1，表示当SCLK=1时处于空闲态，所以有效状态就是SCLK处于低电平时；

CPHA=0，表示数据采样是在第1个边沿，数据发送在第2个边沿；

CPHA=1，表示数据采样是在第2个边沿，数据发送在第1个边沿。

![6][6]

[6]:https://th.bing.com/th/id/OIP.O9a2d7dQGz4qehEwACZdrAAAAA?rs=1&pid=ImgDetMain

### SPI的三种模式

SPI工作在3中模式下，分别是**运行**、**等待**和**停止**。

**运行模式**（Run Mode）

这是基本的操作模式

**等待模式**（Wait Mode）

SPI工作在等待模式是一种可配置的低功耗模式，可以通过SPICR2寄存器的SPISWAI位进行控制。在等待模式下，如果SPISWAI位清0，SPI操作类似于运行模式。如果SPISWAI位置1，SPI进入低功耗状态，并且SPI时钟将关闭。如果SPI配置为主机，所有的传输将停止，但是会在CPU进入运行模式后重新开始。如果SPI配置为从机，会继续接收和传输一个字节，这样就保证从机与主机同步。

**停止模式**（Stop Mode）

为了降低功耗，SPI在停止模式是不活跃的。如果SPI配置为主机，正在进行的传输会停止，但是在CPU进入运行模式后会重新开始。如果SPI配置为从机，会继续接受和发送一个字节，这样就保证了从机与主机同步。

### SPI连接类型：

1主1从 1主+N从（常规模式和菊花链模式）

![7][7]

[7]:https://pic2.zhimg.com/80/v2-806460a48e8b5773c0541f41394905b1_1440w.webp